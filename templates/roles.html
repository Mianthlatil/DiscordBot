
{% extends "base.html" %}

{% block title %}Rollen - Bot Konfiguration{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="fas fa-users"></i> Rollen Konfiguration</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-id-badge"></i> Discord Rollen zuweisen</h5>
                <button id="refreshRoles" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync-alt"></i> Rollen aktualisieren
                </button>
            </div>
            <div class="card-body">
                <div id="loading" class="text-center mb-3" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Lade Discord Rollen...</span>
                    </div>
                    <p>Lade Discord Rollen...</p>
                </div>
                
                <form method="POST" id="roleForm">
                    <div class="mb-3">
                        <label for="role_rekrut" class="form-label">ü•â Rekrut Rolle</label>
                        <div class="input-group">
                            <select class="form-select discord-role-select" data-target="role_rekrut">
                                <option value="">Rolle ausw√§hlen...</option>
                            </select>
                            <input type="text" class="form-control" id="role_rekrut" name="role_rekrut" 
                                   value="{{ config.roles.rekrut if config.roles else '' }}" 
                                   placeholder="1234567890123456789" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="role_member" class="form-label">ü•à Member Rolle</label>
                        <div class="input-group">
                            <select class="form-select discord-role-select" data-target="role_member">
                                <option value="">Rolle ausw√§hlen...</option>
                            </select>
                            <input type="text" class="form-control" id="role_member" name="role_member" 
                                   value="{{ config.roles.member if config.roles else '' }}" 
                                   placeholder="1234567890123456789" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="role_moderator" class="form-label">üõ°Ô∏è Moderator Rolle</label>
                        <div class="input-group">
                            <select class="form-select discord-role-select" data-target="role_moderator">
                                <option value="">Rolle ausw√§hlen...</option>
                            </select>
                            <input type="text" class="form-control" id="role_moderator" name="role_moderator" 
                                   value="{{ config.roles.moderator if config.roles else '' }}" 
                                   placeholder="1234567890123456789" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="role_admin" class="form-label">üëë Admin Rolle</label>
                        <div class="input-group">
                            <select class="form-select discord-role-select" data-target="role_admin">
                                <option value="">Rolle ausw√§hlen...</option>
                            </select>
                            <input type="text" class="form-control" id="role_admin" name="role_admin" 
                                   value="{{ config.roles.admin if config.roles else '' }}" 
                                   placeholder="1234567890123456789" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="role_raid_leader" class="form-label">‚öîÔ∏è Raid Leader Rolle</label>
                        <div class="input-group">
                            <select class="form-select discord-role-select" data-target="role_raid_leader">
                                <option value="">Rolle ausw√§hlen...</option>
                            </select>
                            <input type="text" class="form-control" id="role_raid_leader" name="role_raid_leader" 
                                   value="{{ config.roles.raid_leader if config.roles else '' }}" 
                                   placeholder="1234567890123456789" readonly>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Speichern
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Zur√ºck
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Hilfe</h6>
            </div>
            <div class="card-body">
                <h6>So funktioniert es:</h6>
                <ol class="small">
                    <li>Stelle sicher, dass der Bot online ist</li>
                    <li>W√§hle aus dem Dropdown die gew√ºnschte Discord-Rolle</li>
                    <li>Die Rollen-ID wird automatisch eingetragen</li>
                    <li>Klicke auf "Speichern"</li>
                </ol>
                
                <h6 class="mt-3">Hierarchie:</h6>
                <p class="small">
                    üëë Admin > üõ°Ô∏è Moderator > ‚öîÔ∏è Raid Leader > ü•à Member > ü•â Rekrut
                </p>
                
                <h6 class="mt-3">Status:</h6>
                <div id="roleStatus" class="small">
                    <i class="fas fa-circle text-warning"></i> Lade Rollen...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDiscordRoles();
    
    // Refresh button
    document.getElementById('refreshRoles').addEventListener('click', function() {
        loadDiscordRoles();
    });
    
    // Role selection handlers
    document.querySelectorAll('.discord-role-select').forEach(select => {
        select.addEventListener('change', function() {
            const targetId = this.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);
            
            if (this.value) {
                targetInput.value = this.value;
                targetInput.style.backgroundColor = '#e8f5e8';
            } else {
                targetInput.style.backgroundColor = '';
            }
        });
    });
});

function loadDiscordRoles() {
    const loading = document.getElementById('loading');
    const status = document.getElementById('roleStatus');
    const selects = document.querySelectorAll('.discord-role-select');
    
    loading.style.display = 'block';
    status.innerHTML = '<i class="fas fa-circle text-warning"></i> Lade Rollen...';
    
    fetch('/api/discord_roles')
        .then(response => response.json())
        .then(roles => {
            loading.style.display = 'none';
            
            if (roles.length === 0) {
                status.innerHTML = '<i class="fas fa-circle text-danger"></i> Keine Rollen gefunden - Bot offline?';
                return;
            }
            
            status.innerHTML = `<i class="fas fa-circle text-success"></i> ${roles.length} Rollen geladen`;
            
            // Clear and populate all selects
            selects.forEach(select => {
                const currentValue = document.getElementById(select.getAttribute('data-target')).value;
                
                // Clear existing options except first
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // Add roles
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.name;
                    
                    // Set color if available
                    if (role.color && role.color !== '#000000') {
                        option.style.color = role.color;
                    }
                    
                    // Select if this is the current value
                    if (role.id == currentValue) {
                        option.selected = true;
                        select.style.backgroundColor = '#e8f5e8';
                    }
                    
                    select.appendChild(option);
                });
            });
        })
        .catch(error => {
            console.error('Error loading roles:', error);
            loading.style.display = 'none';
            status.innerHTML = '<i class="fas fa-circle text-danger"></i> Fehler beim Laden';
        });
}
</script>

<style>
.discord-role-select option {
    padding: 5px;
}

.input-group .form-select {
    border-right: 0;
}

.input-group .form-control[readonly] {
    background-color: #f8f9fa;
    border-left: 0;
}

#roleStatus {
    padding: 8px;
    border-radius: 4px;
    background-color: #f8f9fa;
}
</style>
{% endblock %}
