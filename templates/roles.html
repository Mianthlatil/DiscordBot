
{% extends "base.html" %}

{% block title %}Rollen - Bot Konfiguration{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="fas fa-users"></i> Discord Rollen Konfiguration</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-id-badge"></i> Rollen für Bot-Funktionen zuweisen</h5>
                <button id="refreshRoles" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync-alt"></i> Rollen aktualisieren
                </button>
            </div>
            <div class="card-body">
                <div id="loading" class="text-center mb-3" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Lade Discord Rollen...</span>
                    </div>
                    <p>Lade Discord Rollen...</p>
                </div>
                
                <form method="POST" id="roleForm">
                    <div id="roleContainer">
                        <p class="text-muted">Lade Discord Rollen...</p>
                    </div>
                    
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Speichern
                        </button>
                        <button type="button" id="addRole" class="btn btn-success">
                            <i class="fas fa-plus"></i> Rolle hinzufügen
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Zurück
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Hilfe</h6>
            </div>
            <div class="card-body">
                <h6>So funktioniert es:</h6>
                <ol class="small">
                    <li>Stelle sicher, dass der Bot online ist</li>
                    <li>Gib einen Namen für die Rolle ein</li>
                    <li>Wähle die entsprechende Discord-Rolle aus</li>
                    <li>Klicke auf "Speichern"</li>
                </ol>
                
                <h6 class="mt-3">Standard Rollen:</h6>
                <p class="small">
                    • admin - Vollzugriff<br>
                    • moderator - Moderation<br>
                    • raid_leader - Raid Management<br>
                    • member - Vollmitglied<br>
                    • rekrut - Neue Mitglieder
                </p>
                
                <h6 class="mt-3">Status:</h6>
                <div id="roleStatus" class="small">
                    <i class="fas fa-circle text-warning"></i> Lade Rollen...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let discordRoles = [];
let roleCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadDiscordRoles();
    
    // Refresh button
    document.getElementById('refreshRoles').addEventListener('click', function() {
        loadDiscordRoles();
    });
    
    // Add role button
    document.getElementById('addRole').addEventListener('click', function() {
        addRoleRow();
    });
});

function loadDiscordRoles() {
    const loading = document.getElementById('loading');
    const status = document.getElementById('roleStatus');
    
    loading.style.display = 'block';
    status.innerHTML = '<i class="fas fa-circle text-warning"></i> Lade Rollen...';
    
    fetch('/api/discord_roles')
        .then(response => response.json())
        .then(roles => {
            loading.style.display = 'none';
            discordRoles = roles;
            
            if (roles.length === 0) {
                status.innerHTML = '<i class="fas fa-circle text-danger"></i> Keine Rollen gefunden - Bot offline?';
                document.getElementById('roleContainer').innerHTML = '<p class="text-danger">Bot ist offline oder keine Rollen gefunden.</p>';
                return;
            }
            
            status.innerHTML = `<i class="fas fa-circle text-success"></i> ${roles.length} Rollen geladen`;
            
            // Load existing roles from config
            loadExistingRoles();
        })
        .catch(error => {
            console.error('Error loading roles:', error);
            loading.style.display = 'none';
            status.innerHTML = '<i class="fas fa-circle text-danger"></i> Fehler beim Laden';
        });
}

function loadExistingRoles() {
    const container = document.getElementById('roleContainer');
    container.innerHTML = '';
    
    // Load existing roles from config
    fetch('/api/config')
        .then(response => response.json())
        .then(config => {
            const existingRoles = config.roles || {};
            
            // Add standard roles if they exist
            const standardRoles = ['admin', 'moderator', 'raid_leader', 'member', 'rekrut'];
            standardRoles.forEach(role => {
                const roleId = existingRoles[role] || '';
                addRoleRow(role, roleId, true);
            });
            
            // Add custom roles
            const customRoles = config.custom_roles || {};
            Object.entries(customRoles).forEach(([name, roleId]) => {
                if (!standardRoles.includes(name)) {
                    addRoleRow(name, roleId, false);
                }
            });
            
            // Add one empty row for new roles
            if (Object.keys(customRoles).length === 0) {
                addRoleRow();
            }
        })
        .catch(error => {
            console.error('Error loading config:', error);
            addRoleRow(); // Add at least one empty row
        });
}

function addRoleRow(name = '', roleId = '', isStandard = false) {
    const container = document.getElementById('roleContainer');
    const rowId = `role_${roleCounter++}`;
    
    const roleRow = document.createElement('div');
    roleRow.className = 'row mb-3 role-row';
    roleRow.id = rowId;
    
    const inputName = isStandard ? 'role_ids[]' : 'custom_role_ids[]';
    const hiddenInput = isStandard ? `<input type="hidden" name="role_names[]" value="${name}">` : '';
    
    roleRow.innerHTML = `
        <div class="col-md-5">
            <label class="form-label">Rollen-Name ${isStandard ? '<span class="badge bg-primary">Standard</span>' : ''}</label>
            <input type="text" class="form-control role-name" ${isStandard ? 'readonly' : 'name="custom_role_names[]"'} 
                   value="${name}" placeholder="z.B. Administrator">
            ${hiddenInput}
        </div>
        <div class="col-md-6">
            <label class="form-label">Discord Rolle</label>
            <select class="form-select discord-role-select" name="${inputName}">
                <option value="">Rolle auswählen...</option>
                ${discordRoles.map(role => `
                    <option value="${role.id}" ${role.id == roleId ? 'selected' : ''} 
                            ${role.color && role.color !== '#000000' ? `style="color: ${role.color}"` : ''}>
                        ${role.name}
                    </option>
                `).join('')}
            </select>
        </div>
        <div class="col-md-1">
            <label class="form-label">&nbsp;</label>
            ${!isStandard ? `<button type="button" class="btn btn-outline-danger btn-sm d-block remove-role">
                <i class="fas fa-trash"></i>
            </button>` : '<div class="btn btn-sm disabled">Standard</div>'}
        </div>
    `;
    
    container.appendChild(roleRow);
    
    // Add remove functionality for custom roles only
    if (!isStandard) {
        const removeBtn = roleRow.querySelector('.remove-role');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                roleRow.remove();
            });
        }
    }
    
    // Add change event to highlight selected roles
    roleRow.querySelector('.discord-role-select').addEventListener('change', function() {
        if (this.value) {
            this.style.backgroundColor = '#e8f5e8';
        } else {
            this.style.backgroundColor = '';
        }
    });
    
    // Set initial highlight
    if (roleId) {
        roleRow.querySelector('.discord-role-select').style.backgroundColor = '#e8f5e8';
    }
}
</script>

<style>
.role-row {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
}

.discord-role-select option {
    padding: 5px;
}

#roleStatus {
    padding: 8px;
    border-radius: 4px;
    background-color: #f8f9fa;
}

.remove-role {
    margin-top: 32px;
}

.role-row input[readonly] {
    background-color: #e9ecef;
    opacity: 1;
}
</style>
{% endblock %}
